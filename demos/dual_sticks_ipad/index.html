<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Dual Sticks Example</title>
		<meta charset="utf-8">
		<meta
			name="viewport"
			content="width=device-width, user-scalable=yes, initial-scale-1.0, maximum-scale=1.0"
		>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
		</style>
	</head>
	<body>
		<canvas id="stage" width="1024" height="690"></canvas>
		<script>
(function () {

var canvas = document.getElementById("stage");
var context = canvas.getContext("2d");

var WIDTH = canvas.offsetWidth;
var HEIGHT = canvas.offsetHeight;

var pointer = {
	radius: 36,
	x: (WIDTH / 2),
	y: (HEIGHT / 2)
};
var points = [];
var touches = [];

var moveStick = null;
var shootStick = null;

function constrain (value, radius, min, max) {
	if ((value - radius) < min) {
		return (min + radius);
	}
	if ((value + radius) > max) {
		return (max - radius);
	}
	return value;
};

function draw () {
	context.clearRect(0, 0, WIDTH, HEIGHT);

	for (var i = 0; i < points.length; ++i) {
		drawStick(i);
	}

	if (moveStick != null) {
		pointer.x += (moveStick.length * moveStick.normal.x);
		pointer.y += (moveStick.length * moveStick.normal.y);

		pointer.x = constrain(pointer.x, pointer.radius, 0, WIDTH);
		pointer.y = constrain(pointer.y, pointer.radius, 0, HEIGHT);
	}

	drawPointer();
	drawDebug();
};

function drawDebug () {
	context.save();

	context.fillStyle = "rgb(0, 0, 0)";
	context.font = "20px Verdana";
	context.textBaseline = "top";

	var x = parseInt(pointer.x);
	var y = parseInt(pointer.y);
	context.fillText((x + ", " + y), 0, 0);
	context.fillText(shootStick.angle, 0, 20);

	context.restore();
};

function drawPointer () {
	context.save();

	context.beginPath();
	context.arc(pointer.x, pointer.y, pointer.radius, 0, (Math.PI * 2), true);

	if (shootStick != null) {
		var end = getVectorFromRadians(shootStick.angle, pointer.radius);
		context.moveTo(pointer.x, pointer.y);
		context.lineTo(pointer.x + end.x, pointer.y + end.y);
	}

	context.lineWidth = 3;
	context.strokeStyle = "rgb(0, 0, 0)";
	context.stroke();

	context.restore();
};

function subtractVectors (v1, v2) {
	return {
		x: v1.x - v2.x,
		y: v1.y - v2.y
	};
};

function getVectorLength (v) {
	return Math.sqrt(v.x * v.x + v.y * v.y);
};

function getVectorNormal (v) {
	var len = getVectorLength(v);
	if (len === 0) {
		return v;
	} else {
		return {
			x: (v.x * (1 / len)),
			y: (v.y * (1 / len))
		};
	}
};

function getRadians (x, y) {
	return Math.atan2(x, -y);
};

function getVectorFromRadians (radians, length) {
	length = Number(length) || 1;
	return {
		x: Math.sin(radians) * length,
		y: -Math.cos(radians) * length
	};
};

function drawStick (index) {
	var point = points[index];

	if (!point) {
		return;
	}

	context.save();
	context.globalAlpha = 0.5;

	var initial = {
		x: point.initial.x,
		y: point.initial.y
	};

	context.beginPath();
	context.arc(initial.x, initial.y, 72, 0, (Math.PI * 2), true);
	context.lineWidth = 6;
	context.strokeStyle = "rgb(0, 0, 0)";
	context.stroke();

	var movement = {
		x: point.movement.x,
		y: point.movement.y
	};

	var diff = subtractVectors(movement, initial);
	var length = getVectorLength(diff);

	var maxLength = 24;

	var color = "rgb(200, 0, 0)";

	if (length > maxLength) {
		length = maxLength;
		color = "rgb(200, 200, 0)";
		var rads = getRadians(diff.x, diff.y);
		movement = getVectorFromRadians(rads, length);
		movement.x += initial.x;
		movement.y += initial.y;
	}

	if (moveStick == null || initial.x < moveStick.x) {
		moveStick = {
			x: initial.x,
			y: initial.y,
			angle: getRadians(diff.x, diff.y),
			normal: getVectorNormal(diff),
			length: length
		};
	} else if (shootStick == null || initial.x > shootStick.x) {
		// This is the move stick
		shootStick = {
			x: initial.x,
			y: initial.y,
			angle: getRadians(diff.x, diff.y),
			normal: getVectorNormal(diff),
			length: length
		};
	}

	context.beginPath();
	context.arc(movement.x, movement.y, 48, 0, (Math.PI * 2), true);
	context.strokeStyle = color;
	context.stroke();

	context.restore();
};

function init () {
	document.addEventListener("touchstart", function (e) {
		e.preventDefault();
		setPoints(e.touches, "initial");
		setPoints(e.touches, "movement");
	});

	document.addEventListener("touchmove", function (e) {
		e.preventDefault();
		setPoints(e.touches, "movement");
	});

	setInterval(main, 1);
};

function main () {
	moveStick = null;
	shootStick = null;

	draw();
};

function setPoints (touches, key) {
	for (var i = 0; i < touches.length; ++i) {
		var touch = touches[i];
		points[i] = (points[i] || {});

		var heading = Math.atan2(touch.pageX, -touch.pageY);

		if (key == "movement") {
			// TODO: prevent it from moving outside of its parent
			points[i][key] = {
				x: touch.pageX,
				y: touch.pageY
			};

		} else {
			points[i][key] = {
				x: touch.pageX,
				y: touch.pageY
			};
		}

	}
};

init();

}());
		</script>

	</body>
</html>
